import { HttpHeaders, HttpParams, HttpRequest } from "@angular/common/http";
import { httpRequest } from "./_httpRequest";
import { setStore } from "./_store";
import { _save_state } from "./_saveState";
/**
 * Request to an OAuth2 endpoint. Redirects to the endpoint or makes a HttpClient
 *   get or post request.
 *
 * @param method Request method ("""HREF" for redirection)
 * @param url Endpoint URL
 * @param {HttpClient} request- HttpClient object
 * @param config Configuration object saved in memory. Passed by reference and
 *      updated
 * @param customParameters OAuth2 parameters (standard and custom) for the request. (payload)
 * @param endpoint Endpoint name (for error messages and to determine the type of response)
 * @returns Promise with the request response (or error). In test mode the promise
 *      returns an array with the response (or error) and the request payload.
 */
export const request = async (method, url, request, config, // Passed by reference and updated
customParameters = {}, endpoint) => {
    const test = config.configuration?.test;
    const storage = config.configuration?.storage;
    const content_type = config.configuration?.content_type ??
        "application/x-www-form-urlencoded";
    const revocation_header = config.configuration?.revocation_header;
    const tokenHeader = endpoint === "revocation" && revocation_header
        ? {
            Authorization: `Bearer ${customParameters["token"]}`
        }
        : undefined;
    const headersInit = {
        Accept: "application/json",
        "Content-Type": content_type,
        ...tokenHeader,
    };
    const headers = new HttpHeaders(headersInit);
    setStore("test", storage && test ? {} : null);
    if (!url) {
        const err = new Error(`missing endpoint.`, {
            cause: `oauth2 ${endpoint}`,
        });
        throw err;
    }
    if (revocation_header)
        delete customParameters["token"];
    const payload = {};
    // options to params
    for (const key in customParameters) {
        let v = customParameters[key]; // Option value
        Array.isArray(v) && (v = v.join(" ")); // String array to a string of space separated values.
        if (v || v === false)
            payload[key] = v.toString(); // If not nullish nor empty, added to params.
    }
    const params = new HttpParams({ fromObject: payload });
    // For testing purposes
    if (test) {
        const data = Object.keys(payload).length
            ? payload
            : { "@URL": url };
        setStore("test", storage ? data : null);
    }
    if (method == "HREF") {
        _save_state(config, {});
        // Redirection
        const req = new HttpRequest(method, url, null, {
            params,
        });
        location.href = req.urlWithParams;
        return {};
    }
    const req = method == "POST"
        ? request.post(url, "null", {
            headers,
            params,
            observe: "body",
        })
        : request.get(url, {
            headers,
            params,
            observe: "body",
        });
    return httpRequest(req, config, endpoint !== "discovery");
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX3JlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtb2F1dGgyLW9pZGMvc3JjL2xpYi9fcmVxdWVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsV0FBVyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV4RixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVwQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTNDOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUN4QixNQUErQixFQUMvQixHQUFXLEVBQ1gsT0FBbUIsRUFDbkIsTUFBcUIsRUFBRSxrQ0FBa0M7QUFDekQsbUJBQXlDLEVBQUUsRUFDM0MsUUFBOEIsRUFDYyxFQUFFO0lBQzlDLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDO0lBQ3hDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDO0lBQzlDLE1BQU0sWUFBWSxHQUNkLE1BQU0sQ0FBQyxhQUFhLEVBQUUsWUFBWTtRQUNsQyxtQ0FBbUMsQ0FBQztJQUN4QyxNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsaUJBQWlCLENBQUM7SUFDbEUsTUFBTSxXQUFXLEdBQ2IsUUFBUSxLQUFLLFlBQVksSUFBSSxpQkFBaUI7UUFDMUMsQ0FBQyxDQUFDO1lBQ0ksYUFBYSxFQUFFLFVBQVUsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEVBQUU7U0FDdkQ7UUFDSCxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ3BCLE1BQU0sV0FBVyxHQUFHO1FBQ2hCLE1BQU0sRUFBRSxrQkFBa0I7UUFDMUIsY0FBYyxFQUFFLFlBQVk7UUFDNUIsR0FBRyxXQUFXO0tBQ2pCLENBQUM7SUFDRixNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUU3QyxRQUFRLENBQUMsTUFBTSxFQUFFLE9BQU8sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFOUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ1AsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsbUJBQW1CLEVBQUU7WUFDdkMsS0FBSyxFQUFFLFVBQVUsUUFBUSxFQUFFO1NBQzlCLENBQUMsQ0FBQztRQUNILE1BQU0sR0FBRyxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQUUsT0FBTyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUV4RCxNQUFNLE9BQU8sR0FBRyxFQUFtQixDQUFDO0lBRXBDLG9CQUFvQjtJQUNwQixLQUFLLE1BQU0sR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLEdBQUcsZ0JBQWlCLENBQUMsR0FBb0MsQ0FBQyxDQUFDLENBQUMsZUFBZTtRQUNoRixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLHNEQUFzRDtRQUM3RixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSztZQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyw2Q0FBNkM7SUFDcEcsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFJLElBQUksVUFBVSxDQUFDLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUE7SUFFdEQsdUJBQXVCO0lBQ3ZCLElBQUksSUFBSSxFQUFFLENBQUM7UUFDUCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU07WUFDcEMsQ0FBQyxDQUFDLE9BQU87WUFDVCxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFFdEIsUUFBUSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELElBQUksTUFBTSxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ25CLFdBQVcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFdkIsY0FBYztRQUNkLE1BQU0sR0FBRyxHQUFHLElBQUksV0FBVyxDQUFTLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFO1lBQ25ELE1BQU07U0FDVCxDQUFDLENBQUM7UUFDSCxRQUFRLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUM7UUFDbEMsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxHQUFHLEdBQ0wsTUFBTSxJQUFJLE1BQU07UUFDWixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBYyxHQUFHLEVBQUUsTUFBTSxFQUFFO1lBQ25DLE9BQU87WUFDUCxNQUFNO1lBQ04sT0FBTyxFQUFFLE1BQU07U0FDbEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFjLEdBQUcsRUFBRTtZQUMxQixPQUFPO1lBQ1AsTUFBTTtZQUNOLE9BQU8sRUFBRSxNQUFNO1NBQ2xCLENBQUMsQ0FBQztJQUViLE9BQU8sV0FBVyxDQUNkLEdBQUcsRUFDSCxNQUFPLEVBQ1AsUUFBUSxLQUFLLFdBQVcsQ0FDM0IsQ0FBQztBQUNOLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zLCBIdHRwUmVxdWVzdCB9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xuaW1wb3J0IHsgSU9BdXRoMkNvbmZpZywgSU9BdXRoMk1ldGFkYXRhLCBJT0F1dGgyTWV0aG9kcywgSU9BdXRoMlBhcmFtZXRlcnMsIGN1c3RvbVBhcmFtZXRlcnNUeXBlLCBwYXlsb2FkVHlwZSwgc3RyaW5nc09iamVjdCB9IGZyb20gXCIuLi9kb21haW5cIjtcbmltcG9ydCB7IGh0dHBSZXF1ZXN0IH0gZnJvbSBcIi4vX2h0dHBSZXF1ZXN0XCI7XG5pbXBvcnQgeyBzZXRTdG9yZSB9IGZyb20gXCIuL19zdG9yZVwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBfc2F2ZV9zdGF0ZSB9IGZyb20gXCIuL19zYXZlU3RhdGVcIjtcblxuLyoqXG4gKiBSZXF1ZXN0IHRvIGFuIE9BdXRoMiBlbmRwb2ludC4gUmVkaXJlY3RzIHRvIHRoZSBlbmRwb2ludCBvciBtYWtlcyBhIEh0dHBDbGllbnRcbiAqICAgZ2V0IG9yIHBvc3QgcmVxdWVzdC5cbiAqXG4gKiBAcGFyYW0gbWV0aG9kIFJlcXVlc3QgbWV0aG9kIChcIlwiXCJIUkVGXCIgZm9yIHJlZGlyZWN0aW9uKVxuICogQHBhcmFtIHVybCBFbmRwb2ludCBVUkxcbiAqIEBwYXJhbSB7SHR0cENsaWVudH0gcmVxdWVzdC0gSHR0cENsaWVudCBvYmplY3RcbiAqIEBwYXJhbSBjb25maWcgQ29uZmlndXJhdGlvbiBvYmplY3Qgc2F2ZWQgaW4gbWVtb3J5LiBQYXNzZWQgYnkgcmVmZXJlbmNlIGFuZFxuICogICAgICB1cGRhdGVkXG4gKiBAcGFyYW0gY3VzdG9tUGFyYW1ldGVycyBPQXV0aDIgcGFyYW1ldGVycyAoc3RhbmRhcmQgYW5kIGN1c3RvbSkgZm9yIHRoZSByZXF1ZXN0LiAocGF5bG9hZClcbiAqIEBwYXJhbSBlbmRwb2ludCBFbmRwb2ludCBuYW1lIChmb3IgZXJyb3IgbWVzc2FnZXMgYW5kIHRvIGRldGVybWluZSB0aGUgdHlwZSBvZiByZXNwb25zZSlcbiAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCB0aGUgcmVxdWVzdCByZXNwb25zZSAob3IgZXJyb3IpLiBJbiB0ZXN0IG1vZGUgdGhlIHByb21pc2VcbiAqICAgICAgcmV0dXJucyBhbiBhcnJheSB3aXRoIHRoZSByZXNwb25zZSAob3IgZXJyb3IpIGFuZCB0aGUgcmVxdWVzdCBwYXlsb2FkLlxuICovXG5leHBvcnQgY29uc3QgcmVxdWVzdCA9IGFzeW5jIDxUPihcbiAgICBtZXRob2Q6IFwiSFJFRlwiIHwgXCJHRVRcIiB8IFwiUE9TVFwiLFxuICAgIHVybDogc3RyaW5nLFxuICAgIHJlcXVlc3Q6IEh0dHBDbGllbnQsXG4gICAgY29uZmlnOiBJT0F1dGgyQ29uZmlnLCAvLyBQYXNzZWQgYnkgcmVmZXJlbmNlIGFuZCB1cGRhdGVkXG4gICAgY3VzdG9tUGFyYW1ldGVycyA9IDxjdXN0b21QYXJhbWV0ZXJzVHlwZT57fSxcbiAgICBlbmRwb2ludDoga2V5b2YgSU9BdXRoMk1ldGhvZHNcbik6IFByb21pc2U8SU9BdXRoMlBhcmFtZXRlcnMgfCBJT0F1dGgyTWV0YWRhdGE+ID0+IHtcbiAgICBjb25zdCB0ZXN0ID0gY29uZmlnLmNvbmZpZ3VyYXRpb24/LnRlc3Q7XG4gICAgY29uc3Qgc3RvcmFnZSA9IGNvbmZpZy5jb25maWd1cmF0aW9uPy5zdG9yYWdlO1xuICAgIGNvbnN0IGNvbnRlbnRfdHlwZSA9XG4gICAgICAgIGNvbmZpZy5jb25maWd1cmF0aW9uPy5jb250ZW50X3R5cGUgPz9cbiAgICAgICAgXCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcIjtcbiAgICBjb25zdCByZXZvY2F0aW9uX2hlYWRlciA9IGNvbmZpZy5jb25maWd1cmF0aW9uPy5yZXZvY2F0aW9uX2hlYWRlcjtcbiAgICBjb25zdCB0b2tlbkhlYWRlciA9XG4gICAgICAgIGVuZHBvaW50ID09PSBcInJldm9jYXRpb25cIiAmJiByZXZvY2F0aW9uX2hlYWRlclxuICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7Y3VzdG9tUGFyYW1ldGVyc1tcInRva2VuXCJdfWBcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgaGVhZGVyc0luaXQgPSB7XG4gICAgICAgIEFjY2VwdDogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IGNvbnRlbnRfdHlwZSxcbiAgICAgICAgLi4udG9rZW5IZWFkZXIsXG4gICAgfTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKGhlYWRlcnNJbml0KTtcblxuICAgIHNldFN0b3JlKFwidGVzdFwiLCBzdG9yYWdlICYmIHRlc3QgPyB7fSA6IG51bGwpO1xuXG4gICAgaWYgKCF1cmwpIHtcbiAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKGBtaXNzaW5nIGVuZHBvaW50LmAsIHtcbiAgICAgICAgICAgIGNhdXNlOiBgb2F1dGgyICR7ZW5kcG9pbnR9YCxcbiAgICAgICAgfSk7XG4gICAgICAgIHRocm93IGVycjtcbiAgICB9XG5cbiAgICBpZiAocmV2b2NhdGlvbl9oZWFkZXIpIGRlbGV0ZSBjdXN0b21QYXJhbWV0ZXJzW1widG9rZW5cIl07XG5cbiAgICBjb25zdCBwYXlsb2FkID0ge30gYXMgc3RyaW5nc09iamVjdDtcblxuICAgIC8vIG9wdGlvbnMgdG8gcGFyYW1zXG4gICAgZm9yIChjb25zdCBrZXkgaW4gY3VzdG9tUGFyYW1ldGVycykge1xuICAgICAgICBsZXQgdiA9IGN1c3RvbVBhcmFtZXRlcnMhW2tleSBhcyBrZXlvZiB0eXBlb2YgY3VzdG9tUGFyYW1ldGVyc107IC8vIE9wdGlvbiB2YWx1ZVxuICAgICAgICBBcnJheS5pc0FycmF5KHYpICYmICh2ID0gdi5qb2luKFwiIFwiKSk7IC8vIFN0cmluZyBhcnJheSB0byBhIHN0cmluZyBvZiBzcGFjZSBzZXBhcmF0ZWQgdmFsdWVzLlxuICAgICAgICBpZiAodiB8fCB2ID09PSBmYWxzZSkgcGF5bG9hZFtrZXldID0gdi50b1N0cmluZygpOyAvLyBJZiBub3QgbnVsbGlzaCBub3IgZW1wdHksIGFkZGVkIHRvIHBhcmFtcy5cbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXMgPSAgbmV3IEh0dHBQYXJhbXMoeyBmcm9tT2JqZWN0OiBwYXlsb2FkfSlcblxuICAgIC8vIEZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAgaWYgKHRlc3QpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IE9iamVjdC5rZXlzKHBheWxvYWQpLmxlbmd0aFxuICAgICAgICAgICAgPyBwYXlsb2FkXG4gICAgICAgICAgICA6IHsgXCJAVVJMXCI6IHVybCB9O1xuXG4gICAgICAgIHNldFN0b3JlKFwidGVzdFwiLCBzdG9yYWdlID8gZGF0YSA6IG51bGwpO1xuICAgIH1cblxuICAgIGlmIChtZXRob2QgPT0gXCJIUkVGXCIpIHtcbiAgICAgICAgX3NhdmVfc3RhdGUoY29uZmlnLCB7fSlcblxuICAgICAgICAvLyBSZWRpcmVjdGlvblxuICAgICAgICBjb25zdCByZXEgPSBuZXcgSHR0cFJlcXVlc3Q8c3RyaW5nPihtZXRob2QsIHVybCwgbnVsbCwge1xuICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICB9KTtcbiAgICAgICAgbG9jYXRpb24uaHJlZiA9IHJlcS51cmxXaXRoUGFyYW1zO1xuICAgICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3QgcmVxOiBPYnNlcnZhYmxlPHBheWxvYWRUeXBlPiA9XG4gICAgICAgIG1ldGhvZCA9PSBcIlBPU1RcIlxuICAgICAgICAgICAgPyByZXF1ZXN0LnBvc3Q8cGF5bG9hZFR5cGU+KHVybCwgXCJudWxsXCIsIHtcbiAgICAgICAgICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgICBvYnNlcnZlOiBcImJvZHlcIixcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIDogcmVxdWVzdC5nZXQ8cGF5bG9hZFR5cGU+KHVybCwge1xuICAgICAgICAgICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICAgIG9ic2VydmU6IFwiYm9keVwiLFxuICAgICAgICAgICAgICB9KTtcblxuICAgIHJldHVybiBodHRwUmVxdWVzdChcbiAgICAgICAgcmVxLFxuICAgICAgICBjb25maWchLFxuICAgICAgICBlbmRwb2ludCAhPT0gXCJkaXNjb3ZlcnlcIlxuICAgICk7XG59O1xuIl19